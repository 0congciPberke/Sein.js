# 寻找瓶颈

优化是一门大学问，而对于游戏这种软实时系统，其复杂性毋庸置疑。Sein提供了一系列手段来帮助开发者优化自己的项目，来在效果和性能上达到一个平衡。

## 确定瓶颈

无论是何等复杂的系统，要想优化的前提是定位到瓶颈，对于一个游戏，瓶颈的可能之处有很多，比如内存、显存、GPU带宽、CPU性能等等。但一般而言，我们无法直观得看到这些点，而是看到其表层的现象，其中最出名的可能就是“卡顿”了，所谓一个简单的“卡顿”带来了多少伤心泪。  

比如“卡顿”这种现象，就可能有很多种原因，有可能是内存泄漏导致大量无用内存的GC，有可能是CPU逻辑每帧计算过于繁杂（一般是骨骼动画），也可能是GPU每帧运算量过于庞大（比如光照），还可能是DrawCall过多，甚至有可能是和游戏本身八竿子打不着的系统资源不足（比如GlContextLose）等等，这时候就要求我们有合理的手段来排查出问题的症结所在。

## 排查工具和步骤

排查工具分为两种，一种是CPU端的，一种是GPU端的。

CPU端的排查工具就是我们熟悉的**Chrome Debug Tools**，一般我们直接使用**Performance**的功能来录制时间线，之后分析每一帧的CPU耗时（纤细）、GPU耗时（粗略）以及JS内存开销（粗略）。一般而言在这个阶段我们就可以找到CPU瓶颈了，对于Sein而言，最大的开销通常是渲染本身和骨骼动画的计算更新。  

如果发现时内存有明显异常，就可以使用**Chrome Debug Tools**的**Memory**工具进行进一步的定位排查，在这一步一般我们可以分析出内存的主要开销点是在何处。  

而如果在第一步发现是GPU开销过大，那就要使用另外的工具了，这里推荐BabylonJS团队的工具[SpectorJS](http://spector.babylonjs.com/)，这是一个Chrome插件，可以准确分析当前场景所拥有的GL资源，以及每一帧的GL指令，比如尤为重要的`DrawCall`，在这里我们主要是分析问题的成因，究竟是材质没缓存还是资源太多？  

通过这些排查工具，我们一般都可以定为大多数问题的根源，从而进一步确定解决方案。  

>PS: 像是什么设备不兼容、容器导致的极其偶先的神仙问题，这种排查一般是没什么用的，这时候就要靠你强大的工程师直觉了，不要吝惜向引擎开发团队咨询！
